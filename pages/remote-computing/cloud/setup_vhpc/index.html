<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
   <link rel="stylesheet" href="/ws23_ulg_vu_ama_performance/libs/highlight/github.min.css">
   
    <script src="/ws23_ulg_vu_ama_performance/libs/clipboard.min.js"></script>
  
  
  <script src="/ws23_ulg_vu_ama_performance/libs/plotly-1_58_5.min.js"></script> 
  <script>
    // This function is used when calling `\fig{...}` See # Using \fig{...} below
    const PlotlyJS_json = async (div, url) => {
      response = await fetch(url); // get file
      fig = await response.json(); // convert it to json
      // Make the plot fit the screen responsively. See the documentation of plotly.js. https://plotly.com/javascript/responsive-fluid-layout/
      if (typeof fig.config === 'undefined') { fig["config"]={} }
      delete fig.layout.width
      delete fig.layout.height
      fig["layout"]["autosize"] = true
      fig["config"]["autosizable"] = true
      fig["config"]["responsive"] = true

      // make it easier to scroll throught the website rather than being blocked by a figure.
      fig.config["scrollZoom"] = false

      // PlotlyJS.savefig by default add the some more attribute to make a static plot.
      // Disable them to make the website fancier.
      delete fig.config.staticPlot
      delete fig.config.displayModeBar
      delete fig.config.doubleClick
      delete fig.config.showTips

      Plotly.newPlot(div, fig);
    };
  </script>
  
  <link rel="stylesheet" href="/ws23_ulg_vu_ama_performance/css/jtd.css">
<link rel="stylesheet" href="/ws23_ulg_vu_ama_performance/css/extras.css">
<link rel="icon" href="/ws23_ulg_vu_ama_performance/assets/favicon.ico">

<style>
  /* #148 wrap long header */
  .franklin-content a.header-anchor,
  .franklin-toc li a
   {
    word-wrap: break-word;
    white-space: normal;
  }
</style>

   <title>Remote Computing - Cloud Computing - Setup vhpc</title>  
</head>
<body>                      <!-- closed in foot.html -->
<div class="page-wrap">   <!-- closed in foot.html -->
  <!-- SIDE BAR -->
  <div class="side-bar">
    <div class="header">
      <a href="/ws23_ulg_vu_ama_performance/" class="title">
        Julia
      </a>
    </div>
    <label for="show-menu" class="show-menu">MENU</label>
    <input type="checkbox" id="show-menu" role="button">
    <div class="menu" id="side-menu">
      <ul class="menu-list">
        <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/" class="menu-list-link ">Start</a>
        <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/hpc/" class="menu-list-link ">Parallel computing</a>
          <ul class="menu-list-child-list ">
            <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/hpc/performance/" class="menu-list-link ">Measuring performance</a>
            <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/hpc/simd/" class="menu-list-link ">Single Instruction Multiple Data</a>
            <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/hpc/pi/" class="menu-list-link ">&pi; example</a>
            <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/hpc/multithreading/" class="menu-list-link ">Multithreading</a>
            <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/hpc/distributed/" class="menu-list-link ">Distributed computing</a>
            <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/hpc/gpu/" class="menu-list-link ">GPU computing</a>
          </ul>
          <li class="menu-list-item active"><a href="/ws23_ulg_vu_ama_performance/pages/remote-computing/" class="menu-list-link active">Remote computing</a>
            <ul class="menu-list-child-list ">
              <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/remote-computing/history" class="menu-list-link ">History</a>
              <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/remote-computing/hpc/" class="menu-list-link ">High Performance Computing</a>
              <ul class="menu-list-child-list ">
                <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/remote-computing/hpc/basics" class="menu-list-link ">Basics</a>
                <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/remote-computing/hpc/architecture" class="menu-list-link ">Architecture</a>
                <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/remote-computing/hpc/usage" class="menu-list-link ">Usage</a>
              </ul>
              <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/remote-computing/cloud/" class="menu-list-link active">Cloud Computing</a>
                <ul class="menu-list-child-list ">
                  <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/remote-computing/cloud/setup_vhpc" class="menu-list-link active">Setup vHPC</a>
                </ul>
              <li class="menu-list-item "><a href="/ws23_ulg_vu_ama_performance/pages/remote-computing/notes/" class="menu-list-link ">Notes</a>
            </ul>
      </ul>
    </div>
    <div class="footer">
      This is <em>Just the docs</em>, adapted from the <a href="https://github.com/pmarsceill/just-the-docs" target="_blank">Jekyll theme</a>.
    </div>
  </div>
  <!-- CONTENT -->
  <div class="main-content-wrap"> <!-- closed in foot.html -->
    <div class="main-content">    <!-- closed in foot.html -->
      <div class="main-header">
        WS23 971007 VU Advanced Methods and its Applications - Performance topics
      </div>



<!-- Content appended here (in class franklin-content) -->
<div class="franklin-content"><h1 id="setup_vhpc"><a href="#setup_vhpc" class="header-anchor">Setup vHPC</a></h1>
<div class="franklin-toc"><ol><li><a href="#overview">Overview</a></li><li><a href="#cloud_provider">Cloud provider</a></li><li><a href="#setup_of_the_provider">Setup of the provider</a></li><li><a href="#create_your_infrastructure">Create your infrastructure</a></li><li><a href="#configure_the_infrastructure">Configure the infrastructure</a></li></ol></div>
<h2 id="overview"><a href="#overview" class="header-anchor">Overview</a></h2>
<p>We use the setup of the vHPC es used in the other section for testing as one aspect of how some aspects of working with <em>the cloud</em> looks like. </p>
<h2 id="cloud_provider"><a href="#cloud_provider" class="header-anchor">Cloud provider</a></h2>
<p>The cloud is managed my some system this can be one of the public clouds like</p>
<ul>
<li><p>Amazone  <a href="https://aws.amazon.com/">aws</a></p>
</li>
<li><p>Microsoft <a href="https://azure.microsoft.com/">Azure</a></p>
</li>
<li><p>Google <a href="https://cloud.google.com/gcp/">GCP</a></p>
</li>
</ul>
<p>or on premises </p>
<ul>
<li><p><a href="https://www.openstack.org/">openstack</a></p>
</li>
</ul>
<p>Now we do not have such an infrastructure at our disposal but we can still simulate one. We do this with a somewhat powerful server and <a href="https://libvirt.org/">libvirt</a>, this is going to be our cloud provider. </p>
<h2 id="setup_of_the_provider"><a href="#setup_of_the_provider" class="header-anchor">Setup of the provider</a></h2>
<p>The cloud needs to be created as so many other things. Of on premise clouds this means installing the cloud software &#40;openstack&#41; and adding servers, storage, ... to the managed resources.  In our case we install libvirt on Ubuntu.</p>
<h2 id="create_your_infrastructure"><a href="#create_your_infrastructure" class="header-anchor">Create your infrastructure</a></h2>
<p>Now we need to define our infrastructure.  In our case we would like to have</p>
<ul>
<li><p>one Slurm management node</p>
</li>
<li><p>three Slurm worker nodes</p>
</li>
<li><p>storage for each virtual machine</p>
</li>
<li><p>a operating system on each machine - we use Rocky Linux 8</p>
</li>
<li><p>initial setup of the nodes to allow further configuration &#40;service account&#41;</p>
</li>
<li><p>a network for all of the machines</p>
</li>
</ul>
<p>We describe all of this in <a href="https://www.terraform.io/">Terraform</a> a descriptive language that is often used to define infrastructure.  Luckily for us, there is a Terraform provider for libvirt. </p>
<p>The actual code is <code>yml</code>, e.g. below you see the final part of defining the worker nodes.</p>
<pre><code class="language-terraform">resource &quot;libvirt_domain&quot; &quot;worker&quot; &#123;
  count      &#61; var.count_worker_nodes
  name       &#61; &quot;&#36;&#123;format&#40;&quot;&#36;&#123;var.os_prefix&#125;-&#36;&#123;var.w_short&#125;-&#37;02d&quot;, count.index &#43; 1&#41;&#125;.&#36;&#123;var.domain&#125;&quot;
  memory     &#61; var.memory
  vcpu       &#61; var.vcpu
  cloudinit  &#61; element&#40;libvirt_cloudinit_disk.commoninit_worker&#91;*&#93;.id, count.index&#41;
  disk &#123;
    volume_id &#61; element&#40;libvirt_volume.worker&#91;*&#93;.id, count.index&#41;
  &#125;
  network_interface &#123;
    network_name &#61; var.network
    wait_for_lease &#61; true
  &#125;
  console &#123;
    type        &#61; &quot;pty&quot;
    target_port &#61; &quot;0&quot;
    target_type &#61; &quot;serial&quot;
  &#125;
  console &#123;
    type        &#61; &quot;pty&quot;
    target_type &#61; &quot;virtio&quot;
    target_port &#61; &quot;1&quot;
  &#125;
  graphics &#123;
    type        &#61; &quot;spice&quot;
    listen_type &#61; &quot;address&quot;
    autoport    &#61; true
  &#125;

  connection &#123;
    type        &#61; &quot;ssh&quot;
    private_key &#61; file&#40;&quot;~/.ssh/id_rsa&quot;&#41;
    user        &#61; var.user_name
    timeout     &#61; &quot;2m&quot;
    host        &#61; format&#40;&quot;&#36;&#123;var.os_prefix&#125;-&#36;&#123;var.w_short&#125;-&#37;02d&quot;, count.index &#43; 1&#41;
  &#125;
  cpu &#123;
    mode &#61; &quot;host-passthrough&quot;
  &#125;
&#125;</code></pre>
<p>With our <em>Infrastructure as Code</em> we can use Terraform to deploy it and with that we have our machines.  The minimal configuration to have a service account for the next step is done via <code>cloud-init</code>.</p>
<p>This can easily be automated and is often called <strong>Infrastructure as a Service</strong></p>
<h2 id="configure_the_infrastructure"><a href="#configure_the_infrastructure" class="header-anchor">Configure the infrastructure</a></h2>
<p>All we have now is 4 virtual machines that have a Linux on them and an account that can be accessed via <code>ssh</code>. The next step is to actually configure them into a working HPC cluster. </p>
<p>For this we use <a href="https://www.ansible.com/">Ansible</a>.</p>
<p>Again we write some <code>yml</code> files that do the actual configuration. More precisely we used the excellent ansible scripts provided by the <a href="https://github.com/elasticluster/elasticluster">elasticluster</a> project.  Unfortunately, this project is already a bit stale but with some adaptations it works for our setup. </p>
<p>The main idea </p>
<div class="page-foot">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> - <a href="https://ehrensperger.dev/">Gregor Ehrensperger</a>, <a href="https://orcid.org/0000-0003-3601-0852">Peter Kandolf</a>. Last modified: November 16, 2023.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div><!-- CONTENT ENDS HERE -->
    </div> <!-- end of class main-content -->
    </div> <!-- end of class main-content-wrap -->
    </div> <!-- end of class page-wrap-->
    
    
      <script src="/ws23_ulg_vu_ama_performance/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>

      <script>
    (function(){
    
      // Get the elements.
      // - the 'pre' element.
      // - the 'div' with the 'paste-content' id.
    
      var pre = document.getElementsByTagName('pre');
    
      // Add a copy button in the 'pre' element.
      // which only has the className of 'language-'.
    
      for (var i = 0; i < pre.length; i++) {
        var isLanguage = pre[i].children[0].tagName == 'CODE';
    
        if ( isLanguage ) {
          var button           = document.createElement('button');
              button.className = 'copy-button';
              button.textContent = 'Copy';
    
              pre[i].appendChild(button);
        }
      };
    
      // Run Clipboard
    
      var copyCode = new Clipboard('.copy-button', {
        target: function(trigger) {
          return trigger.previousElementSibling;
        }
      });
    
      // On success:
      // - Change the "Copy" text to "Copied".
      // - Swap it to "Copy" in 2s.
      // - Lead user to the "contenteditable" area with Velocity scroll.
    
      copyCode.on('success', function(event) {
        event.clearSelection();
        event.trigger.textContent = 'Copied';
        window.setTimeout(function() {
          event.trigger.textContent = 'Copy';
        }, 2000);
    
      });
    
      // On error (Safari):
      // - Change the  "Press Ctrl+C to copy"
      // - Swap it to "Copy" in 2s.
    
      copyCode.on('error', function(event) {
        event.trigger.textContent = 'Press "Ctrl + C" to copy';
        window.setTimeout(function() {
          event.trigger.textContent = 'Copy';
        }, 5000);
      });
    
    })();
</script>
    
  </body>
</html>

<script>
  var coll = document.getElementsByClassName("collapsible");
  var i;

  for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
      this.classList.toggle("active");
      var content = this.nextElementSibling;
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });
  }
</script>

<script>
  var coll = document.getElementsByClassName("solutioncollapsible");
  var sols = document.getElementsByClassName("solution");
  
  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  const myVar = urlParams.get('solution')

  if ( myVar == 'true') {
    for (i = 0; i < coll.length; i++) {
      coll[i].style.display = "block";
    }

    for (i = 0; i < sols.length; i++) {
      sols[i].style.display = "block";
    }
  }
</script>